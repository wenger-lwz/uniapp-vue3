<script>(function ($) {
  $.fn.product_detail = function (opt) {
    var $container = $("#product_detail_" + opt.product.id);
    var $slider = $container.find(".support-slick").eq(0);
    var $thumbs = $container.find('.product-image__thumbs-content');
    var $document = $(document);
    if (opt.product.images.length > 1) {
      $slider.on('init', function () {
        $(this).find('.swiper-slide').removeClass('hidden');
      }).on('beforeChange', function (event, slick, currentSlide, nextSlide) {
        $container.find(".product-image__swiper_bullets").html((nextSlide + 1) + " / " + opt.product.images.length);
      });
      var initSlider = function () {
        $slider.slick({
          lazyLoad: 'ondemand',
          slidesToShow: 1,
          arrows: false,
          adaptiveHeight: true,
          autoplay: false,
          dots: false,
          infinite: true,
          initialSlide: opt.initialSlide || 0,
          touchThreshold: 10,
          waitForAnimate: false,
          useTransform: true,
          rtl: document.documentElement.getAttribute("dir") == "rtl"
        }).on('beforeChange', function (e, $slick, currentSlide, nextSlide) {
          $thumbs.find(".slick-current").removeClass("slick-slide slick-current").end().find("[data-thumb-idx=" + nextSlide + "]").addClass("slick-slide slick-current");
          var action = $slider.data("once_action");
          if (action) return;
          if (nextSlide == currentSlide) {
            action = "";
          } else if (nextSlide - currentSlide == 1) {
            action = "next";
          } else if (nextSlide - currentSlide == -1) {
            action = "prev";
          } else if (nextSlide == 0) {
            action = "next";
          } else if (nextSlide == $thumbs.children().length - 1) {
            action = "prev";
          }
          $slider.data("once_action", action);

        }).on("afterChange", function (e, $slick, idx) {
          var $first = $thumbs.find(".product-image__thumbs-item:eq(0)");
          var size = $thumbs.children().length;
          /*$thumbs.find(".slick-current").removeClass("slick-slide slick-current").end().find("[data-thumb-idx=" + idx + "]").addClass("slick-slide slick-current");*/

          if ($slider.data("once_action")) {
            var action = $slider.data("once_action");
            // lazy load other thumb images
            $thumbs.find(".lazy-lazyload").addClass("lazyload");
            var invisibleThumbs = 0 - (parseInt($first.css("margin-left"), 10) / 80);
            // console.log(action, invisibleThumbs, idx);
            if (action == "next" && idx - invisibleThumbs == 6) {
              $first.css({ marginLeft: '-' + ((invisibleThumbs + 1) * 80) + 'px' });
            }
            if (action == "next" && idx == 0) {
              $first.css({ marginLeft: '0px' });
            }
            if (action == "prev" && idx == (invisibleThumbs - 1)) {
              $first.css({ marginLeft: '-' + ((invisibleThumbs - 1) * 80) + 'px' });
            }
            if (action == "prev" && idx == (size - 1)) {
              $first.css({ marginLeft: '-' + ((size - 6) * 80) + 'px' });
            }
            $slider.data("once_action", false);
            return;
          }
          var marginLeft = 0;
          if (idx < 6) {
            marginLeft = 0;
          } else if (idx > (size - 6) && size > 6) {
            marginLeft = (size - 6) * 80;
          } else {
            marginLeft = idx * 80;
          }
          $first.css({ marginLeft: '-' + marginLeft + 'px' });
        });
        $slider.find(".d-none").removeClass("d-none");
        $slider.find(".product-image__swiper_img").zoom();
        $thumbs.on("mouseenter", "[data-thumb-idx]", function (e) {
          var idx = e.currentTarget.getAttribute("data-thumb-idx");
          $thumbs.find(".slick-current").removeClass("slick-slide slick-current").end().find("[data-thumb-idx=" + idx + "]").addClass("slick-slide slick-current");
        });
        $thumbs.on("mouseenter", "[data-thumb-idx]", $.debounce(function (e) {
          var idx = e.currentTarget.getAttribute("data-thumb-idx");
          $slider.find(".slick-list,.slick-track").stop();
          $slider.data("once_action", "dummy"); // 不需要计算marginLeft
          $slider.slick("slickGoTo", idx, false);
        }, 300));
        $container.on("click", ".swiper-button-prev,.sep-loaded-slider__button-prev", function () {
          var size = $thumbs.children().length;
          var cur = $slider.slick('slickCurrentSlide');
          var newIdx = cur == 0 ? (size - 1) : (cur - 1);
          $slider.data("once_action", "prev").slick("slickGoTo", newIdx, cur == 0);
        });
        $container.on("click", ".swiper-button-next,.sep-loaded-slider__button-next", function () {
          var size = $thumbs.children().length;
          var cur = $slider.slick('slickCurrentSlide');
          var newIdx = (cur == (size - 1)) ? 0 : cur + 1;
          $slider.data("once_action", "next").slick("slickGoTo", newIdx, (cur == (size - 1)));
        });

      }
      // ajax slick should update until modal visible
      if (opt.ajax) {
        var timer = setInterval(function () {
          if ($('#product-select-modal').length && $('#product-select-modal').is(':visible')) {
            clearInterval(timer);
            initSlider();
          }
        }, 10);
      } else {
        initSlider();
      }
      // 去掉加载过程中的背景
      $container.find(".loading_bg").each(function () {
        if (this.complete) {
          $(this).removeClass("loading_bg");
        } else {
          $(this).one("load", function () {
            $(this).removeClass("loading_bg");
          })
        }
      });
    } else {
      $slider.find("[data-lazy]").each(function () {
        $(this).attr("src", $(this).attr("data-lazy"));
      })
    }
    var variants = opt.product.variants;
    var minPriceVariant = variants.reduce(function (prev, cur) { return parseFloat(prev.price) > parseFloat(cur.price) ? cur : prev }, variants[0]);
    var maxPriceVariant = variants.reduce(function (prev, cur) { return parseFloat(prev.price) < parseFloat(cur.price) ? cur : prev }, variants[0]);
    // 首次拿选择子商品必须从radio中过滤，js 加载前隐藏域的值还没初始化
    var selected = opt.product.options.reduce(function (prev, cur, i) { return prev.filter(function (v) { return v['option' + (i + 1)] == $("[name=option" + (i + 1) + "-" + opt.product.id + "]:checked").val() }) }, variants)[0] || {
      price: parseFloat(minPriceVariant.price),
      price_min: parseFloat(minPriceVariant.price),
      price_max: parseFloat(maxPriceVariant.price),
      compare_at_price: parseFloat(minPriceVariant.compare_at_price),
      off_ratio: parseFloat(minPriceVariant.off_ratio),
      sales: opt.product.sales,
      available_quantity: 999999,
      available: opt.product.available
    };
    $(".selected_variant_id_" + opt.product.id).val(selected.id || "");
    // 兼容
    $document.data("xfproduct", {
      product: opt.product,
      selected: selected,
      selectedVariants: selected.id ? [selected] : opt.product.variants,
      qty: parseInt($("#product_quantity_" + opt.product.id).val(), 10),
      element: $container.selector
    });
    $document.trigger('xf.product.variants.change', $document.data('xfproduct'));
    $container.data('xfproduct', $document.data('xfproduct'));
  }

  $(function () {
    var $document = $(document);
    var $body = $(document.body);
	var vars = eval('('+$('#vars').html()+')');
	var iscombo = $('#comboprod').val();
	
	var cmboChange = function(obj){
		//$('.product-info__qty_container').hide();//套餐不能加数量
		var cid = $(obj).attr("data-cid");
		$('.combo_prods_item').hide();
		$('.product_attr').hide();
		$('.combo_item_'+cid).find('.combo_prods_item').css('display','flex'); 
		$('.combo_item_'+cid).find('.product_attr').show();	
		//初始化选中一个套餐
		
		$('.combo_item_'+cid+' .product_box').each(function(){
			$(this).find(".product-info__variants_items").each(function(){			
				var oneobj = $(this).find("label:first");
				oneobj.trigger('click');
				cmboVariantsChange.call(oneobj);
			})
		});
	}
	
    var cmboVariantsChange = function () {
		var that = this;
		var pobj = $(this).parents('.product_box');
		var pid = pobj.attr('d-pid');
		var variants = vars[pid];		
		pobj.find('[name^=option]:checked, option[name^=option]:selected').each(function (i, r) {
          var indexes = r.id.split("-");
          var valueOpt = r.value;
          variants = variants.filter(function (v) { return v[indexes[0]] == valueOpt });
        });
		var combo_obj = $('input[name="combos"]:checked');
		if(!variants || variants == 'undefined'){
			return;
		}		
		var cid = combo_obj.attr("data-cid");
		var vs = JSON.parse(combo_obj.val());	
		var vinfo = variants[0];
		var vstr = [];
		var hasv = 0;
		var yjp = 0;//
		var productData = $(document).data("xfproduct");

		$.each(vs,function(i,v){
			var pinfoobj = $('.combo_item_'+cid).find('.pinfo'+v['p']);
			if(v['p'] == pid){
				if(!v['vs'][vinfo.id] || v['vs'][vinfo.id] == 'undefined'){
					hasv += 1;
					$('#'+$(that).attr('for')).prop("checked", false).prop("disabled", true);
					return false;
				}
				pobj.attr('d-vid',vinfo.id);
				pobj.attr('d-vp',parseFloat(v['vs'][vinfo.id]));
			}
			var hasp = true;
			var zzprice = 0;
			for(var k = 0; k < parseInt(v['n']); k++){
				var cpobj = $('.combo_item_'+cid).find('.product_box[d-pid="'+v['p']+'"]').eq(k);
				var vid = cpobj.attr('d-vid');
				if(!vid || vid == 'undefined'){
					hasp = false;
					hasv += 1;
					return false;
				}
				zzprice += parseFloat(cpobj.attr('d-vp'));				
				yjp += parseFloat(cpobj.attr('d-vp'));			
				vstr.push({"c":cid,"p":v['p'],"v":vid});				
			}
			pinfoobj.find('.zzprice').show().find('.curPrice').text(zzprice).attr('data-price',zzprice);
		});
		 if(productData){
      if(productData.selected){
        productData.selected.price=yjp.toFixed(2)
        productData.selected.price_min=yjp.toFixed(2)
        productData.selected.price_max=yjp.toFixed(2)
      }
        $(document).data("xfproduct", productData);
        setTimeout(function () {
          $(document).trigger('xf.product.variants.change', productData);
        }, 100);
    }
		if(hasv == 0){
			$('.combo_item_'+cid).attr('cdata',JSON.stringify(vstr));
		}else{
			$('.combo_item_'+cid).removeAttr('cdata');
		}		
		return;
	}

    var variantsChange = function () {
      var $cb = $("#" + $(this).attr("for"));
	  if(iscombo && iscombo == 'yes'){
			var that = this;
			setTimeout(function () { // 等待checked状态变化  
				if($cb.prop("name") == 'combos'){
				  cmboChange(that);
				}else{
				  cmboVariantsChange.call(that);			  
				}
			}, 20);
		return;
	  }
      // checked -> unchecked
      if ($cb.prop("checked")) {
        setTimeout(function () {
          $cb.prop("checked", false);
        }, 10);
      }	  
      // checked
      var productData = $(document).data("xfproduct");
      var variants = productData.product.variants.slice();
      var options = productData.product.options;
      setTimeout(function () { // 等待checked状态变化
        var selectedOpts = [];
        $("#product_detail_" + productData.product.id).find('[name^=option]:checked, option[name^=option]:selected').each(function (i, r) {
          var indexes = r.id.split("-"); // ["option1","0"]
          var optIdx = parseInt(indexes[0].substr(6), 10) - 1;
          var valueIdx = parseInt(indexes[1], 10);
          selectedOpts.push(indexes[0]);
          variants = variants.filter(function (v) {return v[indexes[0]] == options[optIdx].values[valueIdx]});
        });
        $(".selected_variant_id_" + productData.product.id).val(selectedOpts.length == productData.product.options.length ? variants[0].id : "");
        // 重新计算radio disabled状态
        $("#product_detail_" + productData.product.id).find('input.product-info__variants_radio:not(:checked),option.product-info__variants_value:not(:selected)').each(function (i, r) {
          var indexes = r.id.split("-"); // ["option1","0",'id']
          var optIdx = parseInt(indexes[0].substr(6), 10) - 1;
          var valueIdx = parseInt(indexes[1], 10);
          var tmpVariant = $.extend(true, {}, variants[0]);
          tmpVariant[indexes[0]] = options[optIdx].values[valueIdx];
          var tmpSelectedOpts = selectedOpts.slice();
          tmpSelectedOpts.indexOf(indexes[0]) == -1 && (tmpSelectedOpts.push(indexes[0]));
          var disabled = productData.product.variants.filter(function (v) {
            return (v.option1 == tmpVariant.option1 || tmpSelectedOpts.indexOf('option1') === -1) && (v.option2 == tmpVariant.option2 || tmpSelectedOpts.indexOf('option2') === -1) && (v.option3 == tmpVariant.option3 || tmpSelectedOpts.indexOf('option3') === -1) && v.available_quantity > 0;
          }).length == 0;
          $(r).prop("disabled", disabled);
          $(r).html($(r).val());
          $(r).parent('select').val() && disabled && $(r).html($(r).val() + ' (' + $(r).data('soldout') + ')');
          $(r).parent('select').val() && $(r).parent('select').removeClass('tw-text-black tw-opacity-50')
        })
        var minPriceVariant = variants.reduce(function (prev, cur) { return parseFloat(prev.price) > parseFloat(cur.price) ? cur : prev }, variants[0]);
        var maxPriceVariant = variants.reduce(function (prev, cur) { return parseFloat(prev.price) < parseFloat(cur.price) ? cur : prev }, variants[0]);
        productData.selected = (selectedOpts.length == productData.product.options.length ? variants[0] : {
          price: parseFloat(minPriceVariant.price),
          price_min: parseFloat(minPriceVariant.price),
          price_max: parseFloat(maxPriceVariant.price),
          compare_at_price: parseFloat(minPriceVariant.compare_at_price),
          off_ratio: parseFloat(minPriceVariant.off_ratio),
          sales: productData.product.sales,
          available_quantity: 999999,
          available: productData.product.available
        });
        productData.selectedVariants = variants;
        productData.qty = Math.min(parseInt($("#product_quantity_" + productData.product.id).val(), 10), productData.selected.available_quantity);
        $(document).data("xfproduct", productData);
        $(document).trigger('xf.product.variants.change', productData);
        // 色卡label
        !$cb.prop('disabled') && $cb.parents('.product-info__variants_items').find('#variant_color-label').html($cb.prop("checked") ? ' - ' + $cb.val() : '');

        if (productData.selectedVariants.length === 1) {
          // quickview 中不更新url
          if ($('#product-select-modal.show').length) return;
          window.history.replaceState(null, '', '?' + $.toQuery($.extend($.params(), {
            variant: productData.selectedVariants[0].id
          })))
        }
      }, 20);
    }
	if(iscombo && iscombo == 'yes'){		  
		var obj = $("label.combos:first");
		obj.trigger('click');	
		cmboChange(obj);
	}
    //商品切换
    $body.on("click", ".product-info__variants_value label", function () {
      variantsChange.call(this);
    }).on('change', '.product-info__variants_items select', function () {
      variantsChange.call(this);
    });
    //数量
    $body.on('click', "[data-click=decrease],[data-click=increase]", function (e) {
      var t = $(e.target).attr("data-click");
      var productData = $document.data("xfproduct");
      productData.qty = productData.qty || 1;
      productData.qty += (t == "decrease" ? -1 : 1);
      $document.data("xfproduct", productData);
      $document.trigger('xf.product.variants.change', $document.data('xfproduct'));
    })
    // input product_quantity
    $body.on('blur', ".product-info__qty_num", function (e) {
      var productData = $document.data("xfproduct");
      var correctedValue = Math.max(Math.min(parseInt($(this).val().replace(/\D/g, "").replace(/^0*/, ""), 10) || 0, productData.selected.available_quantity || productData.product.available_quantity), 1);
      productData.qty = parseInt(correctedValue, 10);
      $document.data("xfproduct", productData);
      $document.trigger('xf.product.variants.change', $document.data('xfproduct'));
    })
    // slider switch
    $document.on('xf.product.variants.change', function (e, data) {
      if (!data.selected || !data.selected.image  || !data.selected.image.src) return;
      var $slider = $("#product_detail_" + data.product.id + " .support-slick").eq(0);
      var idx = data.product.images.findIndex(function (row) {
        return row.src.replace('https:','') == data.selected.image.src.replace('https:','');
      });
	  if(idx < 0){
		  return;
	  }
      $slider.hasClass('slick-initialized') && $slider.slick('slickGoTo', idx);
	});
      // 更新折扣标签和优惠金额
    $document.on('xf.product.variants.change', function (e, data) {
      var off = window.SHOP_PARAMS.product_lang.off.replace(/\{\s*count\s*\}/, data.selected.off_ratio)
      var $productImage = $("#product_detail_" + data.product.id + ' .product-image');
      if (data.selected.off_ratio > 0 && data.selected.available) {
        var save_html = window.SHOP_PARAMS.product_lang.save_html.replace(/\{\s*saved_amount\s*\}/, (data.selected.compare_at_price - data.selected.price).toFixed(2))
        $productImage.find('.product-info__discount-label').html(off).end().find('.product-info__save-label').html(save_html);
        $productImage.find('.product-info__label').css('opacity', 1);
      } else {
        $productImage.find('.product-info__label').css('opacity', 0);
      }
      $("#product_detail_" + data.product.id + " .product-info__qty_container").html(template("product-info-qty-tpl", { product: $.extend({}, data.product, data.selected, { id: data.product.id }), qty: data.qty }));
      $("#product_detail_" + data.product.id + " .product-info__qty_stock")[data.selectedVariants.length > 1 ? "hide" : "show"]();
      $("#product_detail_" + data.product.id + " .product-info__header-sku")[data.selectedVariants.length > 1 ? "hide" : "show"]().html(data.selected.sku);
      $("#product_detail_" + data.product.id + " .product-info__header_price-wrapper").html(template("product-info-price-wrapper", {
        product: data.selected
      }));
    });



    // PC desc tab
    $body.on("click", ".product-info__desc-tab-header", function (e) {
      if (window.innerWidth <= 768 || $(this).parent().is(".side,.side_close")) return;
      var $cb = $(this).prev(".product-info__desc-tab-cb");
      $cb.addClass("pending").prop("checked", true);
      $(".product-info__desc-tab-cb:not(.pending)").prop("checked", false);
      $cb.removeClass("pending");
      e.preventDefault();
      return false;
    });

    //移动端默认点开第一个tab标签
    if (window.innerWidth < 767.98) $(".product-info__desc-tab-cb").eq(0).prop("checked", true);
    //移动端切换tab
    $body.on("click", ".product-info__desc-tab-header", function (e) {
      if (window.innerWidth > 768) return;
      var _for = $(this).attr('for')
      $('.product-info__label_tabs label').removeClass('product-info__label_tabs_checked');
      $(this).addClass('product-info__label_tabs_checked');
      $('.product-info__label_tabs').animate({
        scrollLeft: $('.product-info__label_tabs').scrollLeft() + $(this).offset().left - 50
      }, 200);
      $('input[id=' + _for + ']').addClass("pending").prop("checked", true);
      $(".product-info__desc-tab-cb:not(.pending)").prop("checked", false);
      $('input[id=' + _for + ']').removeClass("pending");
      e.preventDefault();
      return false;
    });

    // select first tab when resized
    $(window).on("resize", $.debounce(function () {
      if (window.innerWidth <= 768) return;
      var isFirstChecked = $(".product-info__desc-tab").is('.side,.bottom');
      $(".product-info__desc-tab-cb").prop("checked", false);
      if (isFirstChecked) {
        $(".product-info__desc-tab-cb").eq(0).prop("checked", true);
      }
    }));

    // 获取自定义参数
    function getProperties() {
      var productData = $document.data("xfproduct");
      var properties = {};
      var productId = productData.product.id;
      var $properties = $(".product-info-" + productId);
      var formdata = $properties.serializeArray();
      for (var i = 0; i < formdata.length; i++) {
        var result = /properties\[(.+)\]/g.exec(formdata[i].name);
        if (result && result[1]) {
          properties[result[1]] = formdata[i].value;
        }
      }
      var items = $properties.find('.required');
      var valid = true;
      for (i = 0; i < items.length; i++) {
        var $parent = $(items[i]).parents('.line-item-property__field');
        $parent.find('.not-empty').remove();
        if ($(items[i]).val() == '') {
          $(items[i]).addClass('not-empty-field');
          $parent.append('<div class="not-empty" style="color: #ea0000;">can not be empty</div>');
          valid = false;
        } else {
          $parent.removeClass('not-empty-field');
        }
      }
      return valid ? properties : false;
    }
    // add to cart
    $(document).off("xf.common.product.atc").on("xf.common.product.atc", function (e, options) {
      var eid = (Math.random().toString(8).substr(2)).substr(0, 12);
		var price = options.variant?options.variant.price:0;
		dLayers.push({'event':'add_cart','eid':eid,'label':'-p'+options.product_id+'-v'+options.variant_id+'-n'+options.quantity,'price':price});
	  var properties = options.properties || {};
      $.loading.show();
      $.post(shop_url+"/cart/add", {
		proid: options.product_id,
        varid: options.variant_id,
        num: options.quantity,
        properties: properties,
        source: 'xfproduct',
      }).always(function (res) {
        var data = res.readyState ? res.responseJSON : res;
        //addToCart按钮可以选择流程：1）to_cart: 跳到购物车 2）to_checkout: 跳到支付页 3）to_toast:弹提示框，页面不跳转
        var process = options.process;
        if (data.state === "success" || data.state == "1") {
		 $(document.body).trigger("xf.addToCart", {
            id: options.product_id,
            number: options.quantity,
            childrenId: options.variant.id,
            item_price: options.variant.price,
            name: options.product.title,
            type: options.variant.type ? options.variant.type : options.product.type,
            properties: properties,
            quantity: options.quantity,
            variant_id: options.variant.id,
            product_id: options.product_id,
            product: options.product,
            variant: options.variant,
            source: options.source,
            process: options.process
          })
          if (process == 'to_cart') {
            $.loading.hide();
            location.href = '/cart';
            return void 0;
          } else if (process == 'to_checkout') {
            //$.loading.hide();
            $(document).trigger("xf.common.product.buy_now", options);
          } else if (process == 'to_toast') {
            if (!(window.SHOP_PARAMS.product_settings || {}).add_to_cart_toast_type) {
              $.loading.hide();
              $.toast.show({ content: window.SHOP_PARAMS.product_lang.added_to_cart_successfully });
            }
            if (window.SHOP_PARAMS.template_type == '13') { $.loading.hide(); }
          }
          $(document).trigger('xf.common.cart.change')
        } else {
          $.loading.hide();
          $.toast.show({ content: data.message || 'Unknown error', type: 'error' });
        }
      })

    })
    $body.on("click", "[data-click=addToCart]", function (e) {
      var properties = getProperties();
      if (!properties) return;
      var productData = $document.data("xfproduct");
      var values = $.params("?" + $(e.target).parents(".product-info").serialize());
      if (!values.variant_id) {
        $.toast.show({ type: 'error', content: window.SHOP_PARAMS.product_lang.select_variant });
        return;
      }
      values.properties = properties;
      values.process = (window.SHOP_PARAMS.product_settings || {}).add_to_cart_process;
      values.product = productData.product;
      values.variant = productData.selected;
      values.quantity = productData.qty || 1;
      $(document).trigger("xf.common.product.atc", values);
    })
    // buy now
    $(document).off("xf.common.product.buy_now").on("xf.common.product.buy_now", function (e, options) {
		var eid = (Math.random().toString(8).substr(2)).substr(0, 12);
		var price = options.variant?options.variant.price:0;
		dLayers.push({'event':'add_cart','eid':eid,'label':key_o+'-p'+options.product_id+'-v'+options.variant_id+'-n'+options.quantity,'price':price});
		var properties = options.properties || {};
      $.loading.show();
      $.post(shop_url+'/cart/buy_now', {
		proid: options.product_id,
        varid: options.variant_id,
        num: options.quantity,
        properties: properties,
        key_o: key_o,
		combos:options.combos || '',
        source: 'xfproduct',
      }, function (ret) {
        if (ret.state === 'success' || ret.state == "ok") {
          return (location.href = '/checkouts/' + ret.okey);
        } else {
		  $.loading.hide();
          $.toast.show({type: 'error',content:"Some items are not in stock, please re-order"});
        }
      });
    })
    $body.on("click", "[data-click=submit]", function (e) {
      var values = $.params("?" + $(e.target).parents(".product-info").serialize()); 
	  if(iscombo && iscombo == 'yes'){
		var cobj = $('.product_combo').find('input[name="combos"]:checked');
		if(cobj.length>0){	
			var cid = cobj.attr('data-cid');
			values.combos = $('.combo_item_'+cid).attr('cdata');
		}	 		
		if(!values.combos || values.combos == 'undefined'){
			$.toast.show({ type: 'error', content: window.SHOP_PARAMS.product_lang.select_variant});
			return;
		}
	  }else{		  
		if (!values.variant_id) {
			$.toast.show({ type: 'error', content: window.SHOP_PARAMS.product_lang.select_variant });
			return;
		}	 
	  }  
      var properties = getProperties();
      if (!properties) return;
      values.properties = properties;
      $(document).trigger("xf.common.product.buy_now", values);
    })

    // quickview
    $(document).on('xf.common.product.select', function (e, options) {
      //商品列表点击quick view 按钮流程
      var quick_view_process = (window.SHOP_PARAMS.product_settings || {}).quick_view_process;
      // 1)加购提示 2）跳转到购物车
      if (quick_view_process == 'to_toast' || quick_view_process == 'to_cart') {
        $(document).trigger('xf.common.product.atc', {
          product_id: options.id,
          variant_id: options.variantsId,
          quantity: 1,
          process: quick_view_process,
          variant: options.variants,
          product: options.product || {},
        })
        return;
      } else if (quick_view_process == 'to_product_detail') {
        //3）点击跳转到商品详情页
        location.href = options.url;
      } else {
		var url = options.url;
        if (!url) return;
        //4）quick view弹窗
        var originData = $(document).data('xfproduct');
        $(document).on('hide.bs.modal', '#product-select-modal', function () {
          $(document).data('xfproduct', originData);
        });
        $.loading.show();
        var is_select_default_variants = window.SHOP_PARAMS.is_select_default_variants || false;
        $.get(url + (url.indexOf("?") == -1 ? "?" : "&") + "view=ajax&variant=" + (is_select_default_variants ? (options.variantsId || "") : "") + "&preview_theme_id=" + ($.params().preview_theme_id || ""), function (html) {
		  $.loading.hide();
          $('#product-select-modal').remove();
          $('body').prepend(template('product-select-wrapper', {}));
          $("#product-select-modal .product-select-modal").html($(html).find("[data-section-type=product_detail],[data-section-type=product_detail] ~ .card_script:eq(0),.inline-code").wrapAll("<div></div>").parent().html());
          if (window.innerWidth <= 768) {
            $('#product-select-modal').removeClass("fade");
          }
          $('#product-select-modal').modal('show');
          $(document).trigger('plugin_currency_update');
        });
        e.stopPropagation();
        e.preventDefault();
        return false;
      }
    });
    // quick view  detail url
    $document.on('xf.product.variants.change', function (e, data) {
      var selectedVariantId = data.selectedVariants.length > 1 ? "" : ((data.selected && data.selected.id) || "");
      var $link = $("#product_detail_" + data.product.id + " .product-info__url a");
      if (!$link.length) return;
      var href = $link.attr("href").replace(/&*variant=[a-z0-9-]*/, "");
      $link.attr("href", href + (selectedVariantId ? ((href.indexOf("?") == -1 ? "?" : "&") + "variant=" + selectedVariantId) : ""));
    });
	var proid = $('input[name="product_id"]').val();
	if(proid && $('.product-info__header .xfpmks').length <=0){
		$.getJSON(shop_url+"/products/markets/"+proid,function(res){$('.product-info__header .xfpmks').remove();$('.product-info__header').append('<span class="xfpmks"></span>');$('.product-info__header_title').after(res.market.djst);$('.product-info__header_title').after(res.market.sold);$('.product-info__body').before(res.market.dzgz);$('.product-info__body').before(res.market.view);$('.product-info__body').before(res.market.ships);$('.product-info__body').before(res.market.btime);$('.product-info__body').before(res.market.showt);$('.product-info__body').before(res.market.coupon);$('.product-info__qty_container').after(res.market.inventory);});
	}
  });
})(window.jQuery);
</script>