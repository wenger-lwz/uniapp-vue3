<script>'use strict';
!$(function() {
  if (!$.fn.asyncTrigger) {
    /**
     * @param {string} name
     * @param {?} value
     * @param {!Function} resolve
     * @return {?}
     */
    $.fn.asyncTrigger = function(name, value, resolve) {
      var _sizeAnimateTimeStamps = $(this).data(name + ".listeners") || [];
      /**
       * @return {?}
       */
      var processRetryQueue = function() {
        var shift = _sizeAnimateTimeStamps.shift();
        if (!shift) {
          return resolve(false, value);
        }
        shift(value, function(result, Night) {
          return result ? resolve(result) : (value = Night, void processRetryQueue());
        });
      };
      return processRetryQueue(), this;
    };
  }
  if (!$.fn.asyncOn) {
    /**
     * @param {string} name
     * @param {?} e
     * @return {?}
     */
    $.fn.asyncOn = function(name, e) {
      var self = $(this);
      var s = self.data(name + ".listeners") || [];
      return s.push(e), self.data(name + ".listeners", s), this;
    };
  }
  if (!$.fn.asyncOff) {
    /**
     * @param {string} name
     * @param {number} e
     * @return {?}
     */
    $.fn.asyncOff = function(name, e) {
      var el = $(this);
      var r = el.data(name + ".listeners") || [];
      e = r.indexOf(e);
      return -1 < e && r.splice(e, 1), el.data(name + ".listeners", r), this;
    };
  }
  var self = {
    init : function(data) {
      self.settings.is_cart_recommended_products_show = data.settings.is_cart_recommended_products_show;
      self.settings.cart_recommended_products_number = data.settings.cart_recommended_products_number;
      self.model.selected = (data.line_items || []).map(function(data) {
        return data.variant_id;
      });
      self.model.selected_cart_ids = (data.line_items || []).map(function(timeline_mode) {
        return timeline_mode.id;
      });
      self.render(data);
      self.bindEvents();
    },
    settings : {},
    model : {
      selected : [],
      selected_cart_ids : [],
      cartObj : {},
      timeout : 0
    },
    render : function(data) {
	  $.loading.hide();
      var e = ($(document).data("xfcart") && $(document).data("xfcart").line_items || []).map(function(timeline_mode) {
        return timeline_mode.id;
      });
      (data.line_items || []).forEach(function(data) {
        if (data.available && -1 === e.indexOf(data.id) && -1 === self.model.selected_cart_ids.indexOf(data.id)) {
          self.model.selected.push(data.variant_id);
          self.model.selected_cart_ids.push("" + data.id);
        }
      });
      (data.line_items || []).forEach(function(widget) {
        /** @type {boolean} */
        widget.unchecked = -1 === self.model.selected_cart_ids.indexOf(widget.id);
      });
      data.all_selected = (data.line_items || []).filter(function(addressesDoc) {
        return addressesDoc.available;
      }).every(function(learner) {
        return -1 !== self.model.selected_cart_ids.indexOf(learner.id);
      });
      data.available_items = (data.line_items || []).filter(function(addressesDoc) {
        return addressesDoc.available;
      });
      data.all_unavailable = (data.line_items || []).every(function(addressesDoc) {
        return !addressesDoc.available;
      });
      data.selected_count = self.model.selected_cart_ids.length;
      /** @type {!Object} */
      self.model.cartObj = data;
      $(document).data("xfcart", data);
      $("#cart").html(template("cart-art-tpl", data));
      $(document).trigger("xf.common.cart.update", data);
	  $(".cart__discount-container").html(data.upsell);
    },
    bindEvents : function() {
      var $prompt = $("#cart");
      $prompt.on("click", ".cart__item_enabled .cart__counter:not(.cart__counter_disabled)", function() {
        var $img = $(this);
        var $oElemDragged = $img.parents(".cart__item");
        var $range = $oElemDragged.find('input[type="number"]');
        /** @type {number} */
        var value = +$range.val();
        var max = $range.attr("min");
        var min = $range.attr("max");
        if (1 != value || "-" != $img.attr("alt")) {
          if ("+" === $img.attr("alt")) {
            /** @type {number} */
            value = value + 1;
          } else {
            if ("-" === $img.attr("alt")) {
              /** @type {number} */
              value = value - 1;
            }
          }
          value = value < max ? max : min < value ? min : value;
          $range.val(value);
          window.clearTimeout(self.model.timeout);
          self.model.timeout = window.setTimeout(function() {
            $(document).trigger("updateCart", {
              product_id : $oElemDragged.attr("data-track-id"),
              variant_id : $oElemDragged.attr("data-id"),
              id : $oElemDragged.attr("data-cart-id"),
              quantity : value
            });
          }, 200);
        } else {
          $img.parent().next().find(".sep-font-close-circle-thin").trigger("click");
        }
      }).on("click", ".show-modal", function() {
        $("#cart-preview-image .preview-image").attr("src", $(this).attr("data-image"));
        $("#cart-preview-image").modal("show");
      }).on("click", "#cart-preview-image .hide-modal", function() {
        $("#cart-preview-image").modal("hide");
      }).on("click", ".cart__checkbox:not(.cart__checkbox_disabled)", function() {
        $(this).toggleClass("cart__checkbox_checked");
        if ($(this).hasClass("cart__checkbox_total")) {
          if ($(this).hasClass("cart__checkbox_checked")) {
            $(".cart__checkbox:not(.cart__checkbox_disabled)").addClass("cart__checkbox_checked");
          } else {
            $(".cart__checkbox:not(.cart__checkbox_disabled)").removeClass("cart__checkbox_checked");
          }
        }
        if ($(".cart__checkbox:not(.cart__checkbox_total)").length === $(".cart__checkbox_checked:not(.cart__checkbox_total)").length && $(".cart__checkbox_checked:not(.cart__checkbox_total)").length) {
          $(".cart__checkbox_total").addClass("cart__checkbox_checked");
        } else {
          $(".cart__checkbox_total").removeClass("cart__checkbox_checked");
        }
        /** @type {!Array} */
        self.model.selected = [];
        /** @type {!Array} */
        self.model.selected_cart_ids = [];
        $(".cart__checkbox_checked:not(.cart__checkbox_total)").each(function(canCreateDiscussions, e) {
          self.model.selected.push($(e).data("variant-id"));
          self.model.selected_cart_ids.push("" + $(e).data("cart-id"));
        });
        if (self.model.selected_cart_ids.length) {
          $(document).trigger("xf.cart.refresh");
        } else {
          self.render({
            line_items : $(document).data("xfcart").line_items,
            item_count : $(document).data("xfcart").item_count,
            original_line_price : 0,
            original_total_price : 0,
            line_price : 0,
            total_price : 0,
            total_discount : null,
            total_weight : 0,
            note : "",
            discount_line_item_price : null,
            discount_applications : null
          });
        }
      });
      $(document).on("xf.cart.refresh", $.debounce(function(canCreateDiscussions, isSlidingUp) {
        $.ajax({
          type : "POST",
          dataType : "json",
          contentType : "application/json; charset=utf-8",
          url :shop_url+ "/cart/list?source=xfcart&r=" + Math.random().toString(36).slice(-4),
          data : JSON.stringify({
            selected : self.model.selected,
            selected_cart_ids : self.model.selected_cart_ids
          }),
          success : function(response) {
            self.render(response.cart);
          }
        });
      }, 50));
      $(document).on("updateCart", function(canCreateDiscussions, e) {
        self.update(e);
      });
      $(document).on("addToCart", function(canCreateDiscussions, e) {
        self.add(e);
      });
      $(document).on("refreshCart", function(canCreateDiscussions, e) {
        self.render(e);
      });
      $(document).on("deleteCartItem", function(canCreateDiscussions, file) {
        self.deleteItem(file);
      });
      $prompt.on("blur", ".cart__item_enabled .cart__qty-input", function() {
        var t = $(this);
        var $this = t.parents(".cart__item");
        /** @type {number} */
        var value = Math.max(parseInt(t.val(), 10) || 1, 1);
        var max = t.attr("min");
        /** @type {number} */
        var min = ~~t.attr("max");
        var product_id = $this.attr("data-track-id");
        var variant_id = $this.attr("data-id");
        t = $this.attr("data-cart-id");
        value = value < max ? max : min < value ? min : value;
        if ($.cart.model.cartObj.line_items[$("#cart_form .cart__item").index($this)].quantity != value) {
          $(document).trigger("updateCart", {
            product_id : product_id,
              variant_id : variant_id,
              id : t,
              quantity : value
          });
        }
      });
      $prompt.on("click", ".sep-font-close-circle-thin", function() {
        var locfield = $(this).parents(".cart__item");
        setTimeout(function() {
          $(document.body).trigger("xf.removeFromCart", {
            id : locfield.attr("data-track-id"),
            variant_id : locfield.attr("data-id"),
            name : locfield.attr("data-track-name"),
            type : locfield.attr("data-track-type"),
            item_price : locfield.attr("data-track-price"),
            number : locfield.attr("data-track-number")
          });
        }, 50);
        self.deleteItem({
          proid : locfield.attr("data-track-id"),
          varid : locfield.attr("data-id"),
          car_id : locfield.attr("data-cart-id"),
          num : 0,
          source : "xfproduct"
        });
      });
      $prompt.on("click", ".cart__checkout:not(.cart__checkout_disabled)", function() {
        $.loading.show();
        var reqParams = {
          line_items : self.getLineItems(),
          refer_info : {
            source : "cart"
          }
        };
        $(document.body).asyncTrigger("xf.cart_checkout", {
          cart : $(document).data("xfcart"),
          reqParams : reqParams
        }, function(canCreateDiscussions, a) {
          /** @type {string} */
          $.ajax({
			  type : "POST",
			  dataType : "json",
			  url : shop_url+"/cart/checkout?r=" + Math.random().toString(36).slice(-4),
			  data:{ source:'checkout',key_o:key_o },
			  success : function(res) {
				window.location.href='/checkouts/'+res.okey
			  }
			});	
        });
      });
    },
    add : function(item) {
      if (-1 === self.model.selected.indexOf(item.variant_id)) {
        self.model.selected.push(item.variant_id);
      }
      item.selected = self.model.selected;
      item.selected_cart_ids = self.model.selected_cart_ids;
      $.ajax({
        type : "post",
        data : item,
        url : shop_url+"/cart/add?source=xfcart&fields=carts",
        success : function(retu_data) {
			self.render(retu_data.cart),
			$(document).trigger("xf.common.cart.change", retu_data.cart),
			$.toast.show({
				content: window.SHOP_PARAMS.product_lang.added_to_cart_successfully
			})		  
        },
        error : function(deleted_model) {
        }
      });
    },
    update : function(item) {
      var a;
      var target = item.quantity;
      var _cur_ctx = self.model.cartObj.line_items.filter(function(selectFile) {
        return selectFile.id == item.id;
      })[0];
      if (_cur_ctx && _cur_ctx.quantity == target) {
        self.render(self.model.cartObj);
      } else {
        /** @type {*} */
        a = JSON.parse(JSON.stringify(self.model.cartObj));
        $.ajax({
          type : "post",
          data : {
            proid : item.product_id,
            varid : item.variant_id,
            num : item.quantity,
            car_id : item.id,
            selected : self.model.selected,
            selected_cart_ids : self.model.selected_cart_ids,
            source : "xfcart"	
          },
          dataType : "json",
          url :shop_url+ "/cart/add?vid=" + item.variant_id,
          success : function(retu_data) {
            self.render(retu_data.cart),
            $(document).trigger("xf.common.cart.change",retu_data.cart);
          },
          error : function(response) {
            console.log("update error");
            self.render(a);
            success(response.responseJSON ? response.responseJSON.state : "all", response && response.responseJSON && response.responseJSON.errors && response.responseJSON.errors[0] || "Unknown error");
          }
        });
      }
    },
    deleteItem : function(data) {
      /** @type {*} */
      var response = JSON.parse(JSON.stringify(self.model.cartObj));
      self.model.selected_cart_ids = self.model.selected_cart_ids.filter(function(i, s) {
        return i == data.id && self.model.selected.splice(s, 1), i !== data.id;
      });
      data.selected = self.model.selected;
      data.selected_cart_ids = self.model.selected_cart_ids;
      $.loading.show();
      $.ajax({
        type : "post",
        dataType : "json",
        data : data,
        url :shop_url+ "/cart/add?vid=" + data.variant_id,
        success : function(retu_data) {
          $.loading.hide();
          self.render(retu_data.cart),
          $(document).trigger("xf.common.cart.change", retu_data.cart);
        },
        error : function(e) {
          $.loading.hide();
          self.render(response);
          success(e.responseJSON ? e.responseJSON.state : "all", e && e.responseJSON && e.responseJSON.errors && e.responseJSON.errors[0] || "Unknown error");
        }
      });
    },
    getLineItems : function() {
      var cart = $("#cart");
      /** @type {!Array} */
      var manifest = [];
      return cart.find(".cart__item.cart__item_enabled").each(function() {
        var section = $(this);
        if (-1 !== self.model.selected_cart_ids.indexOf(section.attr("data-cart-id"))) {
          manifest.push({
            variant_id : section.attr("data-id"),
            quantity : section.find(".cart__qty-input").val(),
            note : "",
            properties : section.attr("data-properties")
          });
        }
      }), manifest;
    }
  };
  $.cart = self;
  /**
   * @param {?} b
   * @param {string} rev
   * @return {undefined}
   */
  var success = function(b, rev) {
    if (rev) {
      $.toast.show({
        content : rev,
        type : "error"
      });
    }
    if (-1 < ["line_items_variant_not_exist", "line_items_variant_sold_out", "cart_removed", "all"].indexOf(b)) {
      setTimeout(function() {
        location.reload();
      }, 2e3);
    }
  };
  /** @type {!JSONType} */
  window.template.defaults.imports.JSON = JSON;
  $.cart.init(window.cartObj);


}), $(function() {
  var init;
  var update;
  var v = $.cart;  
  if (v.settings.is_cart_recommended_products_show && !$("#atc-modal").length) {
    /**
     * @param {number} result
     * @return {undefined}
     */
    init = function(result) {
      var e;
      var t = window.template("recommended-art-tpl", {
        products : result
      });
      /** @type {number} */
      result = 0;
      if (window.innerWidth) {
        /** @type {number} */
        result = window.innerWidth;
      } else {
        if (document.body && document.body.clientWidth) {
          /** @type {number} */
          result = document.body.clientWidth;
        }
      }
      if (result <= 992) {
        e = $("#mobile-recommended");
        $("#cart").find(".cart__recommended").html("");
      } else {
        e = $("#cart").find(".cart__recommended");
        $("#mobile-recommended").html("");
      }
      e.html(t);
      if ("panda" === $("body").attr("data-theme-name")) {
        $(".btn[data-product-id]").css("display", "none");
      }
      var width = $(".cart__recommended-products .cart__recommended-product:first").outerWidth();
      var tabs = $(".cart__recommended-products_wrapper");
      t = $(".cart__recommended-products").children().length;
      /** @type {number} */
      var x = t * width;
      var $handle = $(".sep-font-angle-left");
      var $slidee = $(".sep-font-angle-right");
      /** @type {boolean} */
      var isSlidee = !("rtl" == $(document).attr("dir"));
      (isSlidee ? $handle : $slidee).addClass("disabled");
      if (t <= 3) {
        (isSlidee ? $slidee : $handle).addClass("disabled");
      }
      if (!isSlidee) {
        tabs.scrollLeft(0);
      }
      $("#cart").off("click.cart_recommend_left").on("click.cart_recommend_left", isSlidee ? ".sep-font-angle-right" : ".sep-font-angle-left", function(i) {
        i.preventDefault();
        i = tabs.scrollLeft();
        if (i < x) {
          tabs.animate({
            scrollLeft : i + width
          }, 200);
        }
      });
      $("#cart").off("click.cart_recommend_right").on("click.cart_recommend_right", isSlidee ? ".sep-font-angle-left" : ".sep-font-angle-right", function(left) {
        left.preventDefault();
        left = tabs.scrollLeft();
        if (0 < left) {
          tabs.animate({
            scrollLeft : left - width
          }, 200);
        }
      });
      tabs.off("scroll.cart_recommend").on("scroll.cart_recommend", function(canCreateDiscussions) {
        var e = tabs.scrollLeft();
        if (0 == e) {
          (isSlidee ? $handle : $slidee).addClass("disabled");
        } else {
          (isSlidee ? $handle : $slidee).removeClass("disabled");
        }
        if (x - 3 * width - 12 <= e) {
          (isSlidee ? $slidee : $handle).addClass("disabled");
        } else {
          (isSlidee ? $slidee : $handle).removeClass("disabled");
        }
      });
    };
    /**
     * @param {string} data
     * @return {undefined}
     */
    update = function(data) {
      /** @type {!Array} */
	  var rest;
      var a;
		  
      var items = [];
      if (data && data.line_items) {
        data.line_items.forEach(function(data) {
          items.push(data.product_id);
        });
      }
	  
      if (0 < items.length) {
        /** @type {string} */
        data = items.join(",");
        $.post("/api/products/tuijian?num="+v.settings.cart_recommended_products_number, {
          product_id : data
        }, function(res) {
          var rest;
          var a;
          if (0 != (rest = (rest = (res.data || []).filter(function(a) {
		  return !items.includes(a.id) && a.available;
			})).slice(0, v.settings.cart_recommended_products_number)).length) {
			  init(rest);
			  a = $(window).width();
			  $(window).off("resize.cart_recommend").on("resize.cart_recommend", $.debounce(function() {
				if ($(window).width() !== a) {
				  a = $(window).width();
				  init(rest);
				}
			  }, 500));
			}		  
        });
      }
    };
    $(document).on("xf.common.cart.update", function() {
      update(v.model.cartObj);
    });
    update(v.model.cartObj);
  }
});
</script>