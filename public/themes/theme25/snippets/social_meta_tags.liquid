{% assign template_base = template.name | split: '.' | first %}
{% assign og_title = shop.name  %}
{% assign og_url = canonical_url %}
{% assign og_type = 'website' %}
{% assign og_description = page_description | default: shop.description | default: shop.name %}
{% if template_base == 'index' %}
  {% if settings.homepage_social_image != blank %}
    {% capture og_image_tags %}
      <meta property="og:image" content="https:{{settings.homepage_social_image | img_url}}">
    {% endcapture %}
    {% capture og_image_secure_url_tags %}
      <meta property="og:image:secure_url" content="https:{{settings.homepage_social_image | img_url}}">
    {% endcapture %}
  {% endif %}
{% elsif template_base == 'product' %}
  {% assign og_title = product.title | strip_html %}
  {% assign og_type = 'product' %}
  {% assign og_description = product.meta_description | newline_to_br | replace: "<br />", " " | default: shop.name %}
  {% if og_description == " " %}
    {% assign og_description = shop.name %}
  {% endif %}
  {% capture og_image_tags %}
    <meta property="og:image" content="{% if product.image.src contains 'http' %}{{ product.image.src }}{% else %}https:{{product.image.src}}{% endif %}">
  {% endcapture %}
  {% capture og_image_secure_url_tags %}
    {% for image in product.images limit:3 %}
      <meta property="og:image:secure_url" content="{% if image.src contains 'http' %}{{ image.src }}{% else %}https:{{image.src}}{% endif %}">
    {% endfor %}
  {% endcapture %}
{% elsif template_base == 'article' %}
  {% assign og_title = article.title | strip_html %}
  {% assign og_type = 'article' %}
  {% assign og_description = article.excerpt_or_content | strip_html %}
  {% if article.image %}
    {% capture og_image_tags %}<meta property="og:image" content="{% if article.image contains 'http' %}{{ article.image }}{% else %}https:{{ article.image }}{% endif %}">{% endcapture %}
    {% capture og_image_secure_url_tags %}<meta property="og:image:secure_url" content="{% if article.image contains 'http' %}{{ article.image }}{% else %}https:{{ article.image }}{% endif %}">{% endcapture %}
  {% endif %}
{% elsif template_base == 'collection' %}
  {% capture og_image_tags %}
    {% if collection.image != blank %}
      <meta property="og:image" content="{% if collection.image.src contains 'http' %}{{ collection.image.src }}{% else %}https:{{ collection.image.src }}{% endif %}">
    {% else %}
      {% for product in collection.products limit: 3 %}
        <meta property="og:image" content="{% if collection.image.src contains 'http' %}{{ product.image.src }}{% else %}https:{{ product.image.src }}{% endif %}">
      {% endfor %}
    {% endif %}
  {% endcapture %}
  {% capture og_image_secure_url_tags %}
    {% if collection.image != blank %}
      <meta property="og:image:secure_url" content="{% if collection.image.src contains 'http' %}{{ collection.image.src }}{% else %}https:{{ collection.image.src }}{% endif %}">
    {% else %}
      {% for product in collection.products limit: 3 %}
        <meta property="og:image:secure_url" content="{% if collection.image.src contains 'http' %}{{ product.image.src }}{% else %}https:{{ product.image.src }}{% endif %}">
      {% endfor %}
    {% endif %}
  {% endcapture %}
{% elsif template_base == 'password' %}
  {% assign og_title = shop.name %}
  {% assign og_url = shop.url %}
  {% assign og_description = shop.description | default: shop.name %}
{% endif %}

<meta property="og:site_name" content="{{ shop.name }}">
<meta property="og:url" content="{{ og_url }}">
<meta property="og:title" content="{{ og_title }}">
<meta property="og:type" content="{{ og_type }}">
<meta property="og:description" content="{{ og_description | strip_html | escape }}">
{% if template_base == 'product' %}
  {% unless product.published %}
    {% assign availability = 'discontinued' %}
  {% else %}
    {% if product.available %}
      {% assign availability = 'in stock' %}
    {% else %}
      {% assign availability = 'out of stock' %}
    {% endif %}
  {% endunless %}
  {% assign selectedVariantId = "" %}
  {% assign selectedVariant = nil %}
  {%  if product.variants.size == 1 %}
    {% for variant in product.variants %}
      {% if variant.available_quantity > 0 %}
        {% assign selectedVariantId = variant.id %}
        {% break %}
      {% endif %}
    {% endfor %}
  {%  endif %}

  {% assign params = REQUEST_URI | split: "?" | last | split: "&" %}
  {% for p in params %}
    {% assign pair = p | split: "=" %}
    {% if pair[0] contains "variant" and pair[1] != '' %}
      {% assign selectedVariantId = pair[1] %}
    {% endif  %}
  {% endfor %}

  {% for variant in product.variants %}
    {% if variant.id == selectedVariantId %}
      {% assign selectedVariant = variant %}
    {% endif %}
  {% endfor %}

  {% if selectedVariant %}
    {% if selectedVariant.available %}
      {% assign availability = 'in stock' %}
    {% else %}
      {% assign availability = 'out of stock' %}
    {% endif %}
  {% endif %}
  <meta property="product:price:amount" content="{% if selectedVariant %}{{ selectedVariant.price }}{% else %}{{ product.price }}{% endif %}">
  <meta property="product:price:currency" content="{{shop.currency_code}}">
  <meta property="product:condition" content="new">
  <meta property="product:availability" content="{{ availability }}">
  <meta property="product:retailer_item_id" content="{% if selectedVariant %}{{ selectedVariant.id }}{% else %}{{ product.id }}{% endif %}">
  {% comment %} 预加载商品选中的第一张图片 {% endcomment %}
  <link rel="preload" as="image" href="{% if selectedVariant and selectedVariant.image.src %}{{ selectedVariant.image.src | img_url: '1080x' }}{% else %}{{ product.image.src | img_url: '1080x' }}{% endif %}">
{% endif %}
{{ og_image_tags }}
{{ og_image_secure_url_tags }}
<meta name="twitter:site" content="{{ settings.social_twitter_link | split: 'twitter.com/' | last | prepend: '@' }}">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ og_title }}">
<meta name="twitter:description" content="{{ og_description | strip_html | escape }}">
